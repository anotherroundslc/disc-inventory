<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Disc Golf Inventory Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    h1, h2, h3 {
      color: #333;
      margin-top: 0;
    }
    .btn {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-block;
    }
    .btn:hover {
      background-color: #1557b0;
    }
    .hidden {
      display: none !important;
    }
    #loading {
      text-align: center;
      margin: 20px 0;
    }
    .spinner {
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    .tab.active {
      border-bottom: 2px solid #1a73e8;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    th, td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f8f9fa;
      font-weight: 500;
    }
    .status-urgent {
      background-color: #f44336;
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .status-soon {
      background-color: #ff9800;
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .status-ok {
      background-color: #4CAF50;
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .plastic-badge {
      display: inline-block;
      padding: 3px 8px;
      background-color: #9c27b0;
      color: white;
      border-radius: 12px;
      font-size: 12px;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }
    .filters > div {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    input, select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .message {
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
    }
    .info {
      background-color: #e3f2fd;
      border: 1px solid #90caf9;
    }
    .warning {
      background-color: #fff8e1;
      border: 1px solid #ffecb3;
    }
    .error {
      background-color: #ffebee;
      border: 1px solid #ffcdd2;
    }
  </style>
</head>
<body>
  <div class="container" id="auth-container">
    <h1>Disc Golf Inventory Manager</h1>
    <p>Connect to your Square account to manage your disc golf inventory.</p>
    
    <div id="auth-section">
      <p>Click the button below to connect your Square account:</p>
      <a href="#" id="connect-btn" class="btn">Connect to Square</a>
    </div>
    
    <div id="loading" class="hidden">
      <p><i class="fas fa-spinner spinner"></i> Connecting to Square...</p>
    </div>
  </div>
  
  <div id="app-container" class="hidden">
    <div class="container">
      <h1>Disc Golf Inventory Manager</h1>
      <p>A daily inventory management system for your disc golf shop</p>
      
      <div id="location-selector" class="hidden">
        <div class="message info">
          <p>Please select your Square location:</p>
          <select id="location-select">
            <option value="">Select a location...</option>
          </select>
          <button id="select-location-btn" class="btn">Select Location</button>
        </div>
      </div>
      
      <div id="app-content" class="hidden">
        <div class="tabs">
          <div class="tab active" data-tab="reorder">Reorder Recommendations</div>
          <div class="tab" data-tab="bestsellers">Best Sellers</div>
          <div class="tab" data-tab="inventory">Full Inventory</div>
          <div class="tab" data-tab="molds">Mold Settings</div>
          <div class="tab" data-tab="vendors">Vendor Settings</div>
          <div class="tab" data-tab="settings">System Settings</div>
        </div>
        
        <div id="reorder-tab" class="tab-content">
          <h2>Reorder Recommendations</h2>
          <p>Based on your turnover rate, vendor lead times, and par levels</p>
          
          <div class="filters">
            <div>
              <label for="status-filter">Status:</label>
              <select id="status-filter">
                <option value="all">All</option>
                <option value="urgent">Urgent</option>
                <option value="soon">Order Soon</option>
                <option value="ok">OK</option>
              </select>
            </div>
            <div>
              <label for="vendor-filter">Vendor:</label>
              <select id="vendor-filter">
                <option value="all">All Vendors</option>
                <option value="Innova">Innova</option>
                <option value="Discraft">Discraft</option>
                <option value="MVP">MVP</option>
              </select>
            </div>
            <div>
              <label for="plastic-filter">Plastic:</label>
              <select id="plastic-filter">
                <option value="all">All Types</option>
                <option value="Star">Star</option>
                <option value="Champion">Champion</option>
                <option value="ESP">ESP</option>
                <option value="Z">Z</option>
              </select>
            </div>
            <button id="refresh-data" class="btn">Refresh Data</button>
          </div>
          
          <div id="loading-data" class="hidden">
            <p><i class="fas fa-spinner spinner"></i> Loading inventory data...</p>
          </div>
          
          <div id="reorder-content">
            <div class="message info">
              <p>Loading your inventory from Square. This may take a moment...</p>
            </div>
            
            <table id="reorder-table">
              <thead>
                <tr>
                  <th>Disc Name</th>
                  <th>Plastic</th>
                  <th>Mold</th>
                  <th>Stock</th>
                  <th>Par</th>
                  <th>Vendor</th>
                  <th>Lead Time</th>
                  <th>Status</th>
                  <th>Order</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="reorder-body">
                <!-- Data will be loaded dynamically -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div id="bestsellers-tab" class="tab-content hidden">
          <h2>Coming Soon!</h2>
          <p>The Best Sellers tab is under development and will be available soon.</p>
        </div>
        
        <div id="inventory-tab" class="tab-content hidden">
          <h2>Coming Soon!</h2>
          <p>The Full Inventory tab is under development and will be available soon.</p>
        </div>
        
        <div id="molds-tab" class="tab-content hidden">
          <h2>Coming Soon!</h2>
          <p>The Mold Settings tab is under development and will be available soon.</p>
        </div>
        
        <div id="vendors-tab" class="tab-content hidden">
          <h2>Coming Soon!</h2>
          <p>The Vendor Settings tab is under development and will be available soon.</p>
        </div>
        
        <div id="settings-tab" class="tab-content hidden">
          <h2>Coming Soon!</h2>
          <p>The System Settings tab is under development and will be available soon.</p>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Configuration
    const config = {
      applicationId: 'sq0idp-bici90kAD4rdS4sT0uf8GA',
      redirectUri: 'https://preeminent-puppy-be2708.netlify.app/auth-callback',
      scopes: ['ITEMS_READ', 'INVENTORY_READ', 'ORDERS_READ']
    };
    
    // Application state
    let state = {
      token: localStorage.getItem('square_access_token'),
      locationId: localStorage.getItem('square_location_id'),
      locations: [],
      inventory: [],
      catalog: [],
      vendors: [
        { name: 'Innova', leadTime: 7 },
        { name: 'Discraft', leadTime: 7 },
        { name: 'MVP', leadTime: 14 },
        { name: 'Dynamic Discs', leadTime: 10 },
        { name: 'Latitude 64', leadTime: 10 },
        { name: 'Westside', leadTime: 10 }
      ],
      molds: [],
      defaultParLevel: 15
    };
    
    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      // Check for authentication token in URL hash (returned from auth-callback)
      const hash = window.location.hash.substring(1);
      if (hash && hash.length > 20) {
        // Looks like a token
        localStorage.setItem('square_access_token', hash);
        state.token = hash;
        window.location.hash = '';
      }
      
      if (state.token) {
        // We have a token, show the app
        authContainer.classList.add('hidden');
        appContainer.classList.remove('hidden');
        
        if (state.locationId) {
          // We have a location, show the app content
          document.getElementById('location-selector').classList.add('hidden');
          document.getElementById('app-content').classList.remove('hidden');
          loadInventoryData();
        } else {
          // We need to select a location first
          document.getElementById('location-selector').classList.remove('hidden');
          loadLocations();
        }
      }
      
      // Set up event listeners
      setupEventListeners();
    });
    
    // Set up event listeners
    function setupEventListeners() {
      // Connect button
      const connectBtn = document.getElementById('connect-btn');
      if (connectBtn) {
        connectBtn.addEventListener('click', function(e) {
          e.preventDefault();
          initiateOAuth();
        });
      }
      
      // Select location button
      const selectLocationBtn = document.getElementById('select-location-btn');
      if (selectLocationBtn) {
        selectLocationBtn.addEventListener('click', function() {
          const locationSelect = document.getElementById('location-select');
          const locationId = locationSelect.value;
          
          if (!locationId) {
            alert('Please select a location');
            return;
          }
          
          // Save the selected location
          localStorage.setItem('square_location_id', locationId);
          state.locationId = locationId;
          
          // Show the app content
          document.getElementById('location-selector').classList.add('hidden');
          document.getElementById('app-content').classList.remove('hidden');
          
          // Load inventory data
          loadInventoryData();
        });
      }
      
      // Tab navigation
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          // Remove active class from all tabs
          document.querySelectorAll('.tab').forEach(t => {
            t.classList.remove('active');
          });
          
          // Hide all tab contents
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
          });
          
          // Show the selected tab and content
          this.classList.add('active');
          const tabId = this.getAttribute('data-tab') + '-tab';
          document.getElementById(tabId).classList.remove('hidden');
        });
      });
      
      // Refresh data button
      const refreshBtn = document.getElementById('refresh-data');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', loadInventoryData);
      }
    }
    
    // Initialize OAuth flow
    function initiateOAuth() {
      // Show loading indicator
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('auth-section').classList.add('hidden');
      
      // Build the OAuth URL
      const oauthUrl = `https://connect.squareup.com/oauth2/authorize?client_id=${config.applicationId}&scope=${config.scopes.join('+')}&response_type=code&redirect_uri=${encodeURIComponent(config.redirectUri)}`;
      
      // Redirect to Square OAuth page
      window.location.href = oauthUrl;
    }
    
    // Load locations from Square
    async function loadLocations() {
      try {
        const response = await fetch('https://connect.squareup.com/v2/locations', {
          headers: {
            'Authorization': `Bearer ${state.token}`,
            'Content-Type': 'application/json',
            'Square-Version': '2023-09-25'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error ${response.status}`);
        }
        
        const data = await response.json();
        state.locations = data.locations || [];
        
        // Populate location select
        const locationSelect = document.getElementById('location-select');
        locationSelect.innerHTML = '<option value="">Select a location...</option>';
        
        state.locations.forEach(location => {
          const option = document.createElement('option');
          option.value = location.id;
          option.textContent = location.name;
          locationSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading locations:', error);
        alert('Error loading locations. Please try again.');
      }
    }
    
    // Load inventory data from Square
    async function loadInventoryData() {
      if (!state.token || !state.locationId) {
        console.error('Missing token or locationId');
        return;
      }
      
      try {
        document.getElementById('loading-data').classList.remove('hidden');
        
        // Load catalog items
        const catalogResponse = await fetch('https://connect.squareup.com/v2/catalog/list?types=ITEM', {
          headers: {
            'Authorization': `Bearer ${state.token}`,
            'Content-Type': 'application/json',
            'Square-Version': '2023-09-25'
          }
        });
        
        if (!catalogResponse.ok) {
          throw new Error(`HTTP error ${catalogResponse.status}`);
        }
        
        const catalogData = await catalogResponse.json();
        state.catalog = catalogData.objects || [];
        
        // Load inventory counts
        const inventoryResponse = await fetch(`https://connect.squareup.com/v2/inventory/counts?location_ids=${state.locationId}`, {
          headers: {
            'Authorization': `Bearer ${state.token}`,
            'Content-Type': 'application/json',
            'Square-Version': '2023-09-25'
          }
        });
        
        if (!inventoryResponse.ok) {
          throw new Error(`HTTP error ${inventoryResponse.status}`);
        }
        
        const inventoryData = await inventoryResponse.json();
        state.inventory = inventoryData.counts || [];
        
        // Process and display inventory data
        processInventoryData();
        
        document.getElementById('loading-data').classList.add('hidden');
      } catch (error) {
        console.error('Error loading inventory data:', error);
        document.getElementById('loading-data').classList.add('hidden');
        
        const reorderContent = document.getElementById('reorder-content');
        reorderContent.innerHTML = `
          <div class="message error">
            <p>Error loading inventory data: ${error.message}</p>
            <p>Please try refreshing or reconnecting to Square.</p>
          </div>
        `;
      }
    }
    
    // Process inventory data
    function processInventoryData() {
      // Create a map of catalog item variations to their parent items
      const catalogMap = {};
      state.catalog.forEach(item => {
        if (item.type === 'ITEM' && item.item_data && item.item_data.variations) {
          item.item_data.variations.forEach(variation => {
            catalogMap[variation.id] = {
              parentId: item.id,
              parentName: item.item_data.name,
              variationName: variation.item_variation_data.name,
              sku: variation.item_variation_data.sku || '',
              price: variation.item_variation_data.price_money 
                ? variation.item_variation_data.price_money.amount / 100 
                : 0
            };
          });
        }
      });
      
      // Process inventory counts
      const inventoryItems = state.inventory.map(count => {
        const catalogItem = catalogMap[count.catalog_object_id] || {};
        const fullName = catalogItem.parentName 
          ? `${catalogItem.parentName} ${catalogItem.variationName}`.trim() 
          : 'Unknown Item';
          
        // Extract plastic type and mold from the name
        const { plastic, mold } = extractPlasticAndMold(fullName);
        
        // Get vendor from naming convention or default to first word
        const vendor = extractVendor(fullName, catalogItem.sku);
        
        // Get vendor lead time
        const vendorObj = state.vendors.find(v => v.name === vendor);
        const leadTime = vendorObj ? vendorObj.leadTime : 7; // Default to 7 days
        
        // Calculate stock status
        const stock = parseInt(count.quantity || 0);
        const parLevel = state.defaultParLevel; // Will be customizable in full implementation
        
        let status = 'OK';
        if (stock <= parLevel * 0.2) {
          status = 'URGENT';
        } else if (stock <= parLevel * 0.5) {
          status = 'SOON';
        }
        
        // Calculate recommended order quantity
        const recommendedOrder = status === 'OK' ? 0 : parLevel - stock;
        
        return {
          name: fullName,
          sku: catalogItem.sku,
          plastic,
          mold,
          vendor,
          stock,
          parLevel,
          leadTime,
          status,
          recommendedOrder,
          price: catalogItem.price
        };
      });
      
      // Filter out non-disc items or items we don't want to show
      const filteredItems = inventoryItems.filter(item => {
        // Include only items with a recognized mold
        return item.mold && item.name.toLowerCase().includes('disc'); 
      });
      
      // Sort by status (URGENT first, then SOON, then OK)
      const sortedItems = filteredItems.sort((a, b) => {
        const statusOrder = { 'URGENT': 0, 'SOON': 1, 'OK': 2 };
        return statusOrder[a.status] - statusOrder[b.status];
      });
      
      // Display in the reorder table
      displayReorderItems(sortedItems);
    }
    
    // Extract plastic type and mold from item name
    function extractPlasticAndMold(name) {
      // Common plastic types
      const plasticTypes = [
        'Star', 'Champion', 'DX', 'Pro', 'XT', 'GStar', 'Halo', 'Blizzard',
        'ESP', 'Z', 'FLX', 'Titanium', 'Jawbreaker', 'CryZtal', 'Elite',
        'Neutron', 'Plasma', 'Proton', 'Electron', 'Cosmic',
        'Gold', 'Opto', 'VIP', 'Tournament', 'Fuzion', 'Lucid', 'Prime'
      ];
      
      // Try to extract plastic type
      let plastic = 'Unknown';
      let mold = name;
      
      for (const type of plasticTypes) {
        if (name.includes(type)) {
          plastic = type;
          // Remove plastic type from name to get mold
          mold = name.replace(type, '').trim();
          // Remove any leading/trailing special characters
          mold = mold.replace(/^[^a-zA-Z0-9]+|[^a-zA-Z0-9]+$/g, '');
          break;
        }
      }
      
      // If mold contains numbers, try to clean it up
      mold = mold.replace(/\d+$/, '').trim();
      
      return { plastic, mold };
    }
    
    // Extract vendor from naming convention or SKU
    function extractVendor(name, sku) {
      const vendors = {
        'Innova': ['Innova', 'Star', 'Champion', 'DX', 'GStar'],
        'Discraft': ['Discraft', 'ESP', 'Z', 'Elite'],
        'MVP': ['MVP', 'Axiom', 'Streamline', 'Neutron', 'Plasma'],
        'Dynamic Discs': ['Dynamic', 'Lucid', 'Fuzion'],
        'Latitude 64': ['Latitude', 'Gold', 'Opto'],
        'Westside': ['Westside', 'VIP', 'Tournament']
      };
      
      // Try to match vendor from name or SKU
      for (const [vendor, keywords] of Object.entries(vendors)) {
        for (const keyword of keywords) {
          if (name.includes(keyword) || (sku && sku.includes(keyword))) {
            return vendor;
          }
        }
      }
      
      // Default to first vendor
      return 'Innova';
    }
    
    // Display items in the reorder table
    function displayReorderItems(items) {
      const tbody = document.getElementById('reorder-body');
      tbody.innerHTML = '';
      
      if (items.length === 0) {
        const noItemsRow = document.createElement('tr');
        noItemsRow.innerHTML = `
          <td colspan="10" style="text-align: center;">No items found that need reordering.</td>
        `;
        tbody.appendChild(noItemsRow);
        return;
      }
      
      items.forEach(item => {
        const row = document.createElement('tr');
        
        // Determine status class
        const statusClass = `status-${item.status.toLowerCase()}`;
        
        row.innerHTML = `
          <td>${item.name}</td>
          <td><span class="plastic-badge">${item.plastic}</span></td>
          <td>${item.mold}</td>
          <td>${item.stock}</td>
          <td>${item.parLevel}</td>
          <td>${item.vendor}</td>
          <td>${item.leadTime} days</td>
          <td><span class="${statusClass}">${item.status}</span></td>
          <td>${item.recommendedOrder}</td>
          <td><button class="btn">Order</button></td>
        `;
        
        tbody.appendChild(row);
      });
    }
  </script>
</body>
</html>
