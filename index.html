<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Disc Golf Inventory Manager (Demo)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    h1, h2, h3 {
      color: #333;
      margin-top: 0;
    }
    .btn {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-block;
    }
    .btn:hover {
      background-color: #1557b0;
    }
    .btn-green {
      background-color: #4CAF50;
    }
    .btn-green:hover {
      background-color: #388E3C;
    }
    .btn-red {
      background-color: #f44336;
    }
    .btn-red:hover {
      background-color: #d32f2f;
    }
    .hidden {
      display: none !important;
    }
    #loading {
      text-align: center;
      margin: 20px 0;
    }
    .spinner {
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    .tab.active {
      border-bottom: 2px solid #1a73e8;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    th, td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f8f9fa;
      font-weight: 500;
    }
    tr:hover {
      background-color: #f5f5f5;
    }
    .status-urgent {
      background-color: #f44336;
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .status-soon {
      background-color: #ff9800;
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .status-ok {
      background-color: #4CAF50;
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .plastic-badge {
      display: inline-block;
      padding: 3px 8px;
      background-color: #9c27b0;
      color: white;
      border-radius: 12px;
      font-size: 12px;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }
    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    input, select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .message {
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 4px;
    }
    .info {
      background-color: #e3f2fd;
      border: 1px solid #90caf9;
    }
    .success {
      background-color: #e8f5e9;
      border: 1px solid #c8e6c9;
    }
    .warning {
      background-color: #fff8e1;
      border: 1px solid #ffecb3;
    }
    .error {
      background-color: #ffebee;
      border: 1px solid #ffcdd2;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
      align-items: center;
    }
    @media (max-width: 768px) {
      .tabs {
        flex-direction: column;
      }
      .tab {
        padding: 10px;
      }
      .filters {
        flex-direction: column;
        align-items: stretch;
      }
    }
    .demo-badge {
      background-color: #ff9800;
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <!-- App Container -->
  <div class="container" id="app-container">
    <h1>Disc Golf Inventory Manager <span class="demo-badge">Demo Mode</span></h1>
    <p>A daily inventory management system for your disc golf shop</p>
    
    <div class="message info">
      <p><strong>Demo Mode Active</strong> - This version uses sample data instead of connecting to your Square account. All changes are saved locally in your browser.</p>
    </div>
    
    <!-- Location Selector -->
    <div id="location-selector">
      <div class="message info">
        <h3>Select Your Store Location</h3>
        <p>Please select the location you want to manage:</p>
        <div class="form-row">
          <select id="location-select" style="min-width: 200px;">
            <option value="">Loading locations...</option>
          </select>
          <button id="select-location-btn" class="btn">Select Location</button>
        </div>
      </div>
    </div>
    
    <!-- Main App Content -->
    <div id="app-content" class="hidden">
      <!-- Tab Navigation -->
      <div class="tabs">
        <div class="tab active" data-tab="reorder">Reorder Recommendations</div>
        <div class="tab" data-tab="bestsellers">Best Sellers</div>
        <div class="tab" data-tab="inventory">Full Inventory</div>
        <div class="tab" data-tab="molds">Mold Settings</div>
        <div class="tab" data-tab="vendors">Vendor Settings</div>
        <div class="tab" data-tab="settings">Settings</div>
      </div>
      
      <!-- Reorder Tab -->
      <div id="reorder-tab" class="tab-content">
        <h2>Reorder Recommendations</h2>
        <p>Based on your turnover rate, vendor lead times, and par levels</p>
        
        <div class="filters">
          <div class="filter-group">
            <label for="status-filter">Status:</label>
            <select id="status-filter">
              <option value="all">All</option>
              <option value="urgent">Urgent</option>
              <option value="soon">Order Soon</option>
              <option value="ok">OK</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="vendor-filter">Vendor:</label>
            <select id="vendor-filter">
              <option value="all">All Vendors</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="plastic-filter">Plastic:</label>
            <select id="plastic-filter">
              <option value="all">All Types</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="mold-filter">Mold:</label>
            <select id="mold-filter">
              <option value="all">All Molds</option>
            </select>
          </div>
          <button id="refresh-data" class="btn">
            <i class="fas fa-sync-alt"></i> Refresh Data
          </button>
        </div>
        
        <div id="loading-data" class="hidden">
          <p style="text-align: center;">
            <i class="fas fa-spinner spinner"></i> Loading inventory data...
          </p>
        </div>
        
        <div id="reorder-content">
          <table id="reorder-table">
            <thead>
              <tr>
                <th>Disc Name</th>
                <th>Plastic</th>
                <th>Mold</th>
                <th>Current Stock</th>
                <th>Par Level</th>
                <th>Vendor</th>
                <th>Lead Time</th>
                <th>Status</th>
                <th>Order Qty</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="reorder-body">
              <!-- Data will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Best Sellers Tab -->
      <div id="bestsellers-tab" class="tab-content hidden">
        <h2>Best Selling Molds</h2>
        <p>Track your top-selling discs across different time periods</p>
        
        <div class="message warning">
          <p><strong>Demo Feature:</strong> The Best Sellers analysis shows sample data to demonstrate functionality.</p>
        </div>
        
        <div class="filters">
          <div class="filter-group">
            <label for="time-period">Time Period:</label>
            <select id="time-period">
              <option value="day">Today</option>
              <option value="week">This Week</option>
              <option value="month" selected>This Month</option>
              <option value="year">This Year</option>
              <option value="all">All Time</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="bestseller-vendor">Vendor:</label>
            <select id="bestseller-vendor">
              <option value="all">All Vendors</option>
            </select>
          </div>
          <button id="generate-report" class="btn">
            <i class="fas fa-chart-bar"></i> Generate Report
          </button>
        </div>
        
        <div class="card">
          <h3>Top Selling Molds</h3>
          <table id="bestsellers-table">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Mold</th>
                <th>Vendor</th>
                <th>Units Sold</th>
                <th>Revenue</th>
                <th>% of Sales</th>
                <th>Current Stock</th>
                <th>Par Level</th>
              </tr>
            </thead>
            <tbody id="bestsellers-body">
              <!-- Will be populated with demo data -->
            </tbody>
          </table>
        </div>
        
        <div class="card">
          <h3>Sales Trends</h3>
          <p>Compare sales performance over different time periods</p>
          
          <table id="trends-table">
            <thead>
              <tr>
                <th>Mold</th>
                <th>Current Period</th>
                <th>Previous Period</th>
                <th>Change (%)</th>
                <th>Trend</th>
              </tr>
            </thead>
            <tbody id="trends-body">
              <!-- Will be populated with demo data -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Full Inventory Tab -->
      <div id="inventory-tab" class="tab-content hidden">
        <h2>Full Inventory</h2>
        <p>View and manage your complete disc inventory</p>
        
        <div class="filters">
          <div class="filter-group">
            <label for="inventory-search">Search:</label>
            <input type="text" id="inventory-search" placeholder="Search discs...">
          </div>
          <div class="filter-group">
            <label for="inventory-vendor">Vendor:</label>
            <select id="inventory-vendor">
              <option value="all">All Vendors</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="inventory-plastic">Plastic:</label>
            <select id="inventory-plastic">
              <option value="all">All Types</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="inventory-mold">Mold:</label>
            <select id="inventory-mold">
              <option value="all">All Molds</option>
            </select>
          </div>
        </div>
        
        <div id="loading-inventory" class="hidden">
          <p style="text-align: center;">
            <i class="fas fa-spinner spinner"></i> Loading inventory data...
          </p>
        </div>
        
        <div id="inventory-content">
          <table id="inventory-table">
            <thead>
              <tr>
                <th>Disc Name</th>
                <th>SKU</th>
                <th>Plastic</th>
                <th>Mold</th>
                <th>Vendor</th>
                <th>Current Stock</th>
                <th>Par Level</th>
                <th>Price</th>
              </tr>
            </thead>
            <tbody id="inventory-body">
              <!-- Data will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Mold Settings Tab -->
      <div id="molds-tab" class="tab-content hidden">
        <h2>Mold Settings</h2>
        <p>Configure par levels and archive molds you no longer wish to carry</p>
        
        <div class="card">
          <h3>Add New Mold</h3>
          <div class="form-row">
            <div>
              <label for="new-mold-name">Mold Name:</label>
              <input type="text" id="new-mold-name" placeholder="e.g. Destroyer">
            </div>
            <div>
              <label for="new-mold-vendor">Vendor:</label>
              <select id="new-mold-vendor"></select>
            </div>
            <div>
              <label for="new-mold-par">Par Level:</label>
              <input type="number" id="new-mold-par" value="15" min="0" style="width: 60px;">
            </div>
            <button id="add-mold-btn" class="btn">Add Mold</button>
          </div>
        </div>
        
        <div class="card">
          <h3>Current Molds</h3>
          <p>Set par levels or archive molds you no longer wish to carry</p>
          
          <div class="filters">
            <div class="filter-group">
              <label for="mold-search">Search:</label>
              <input type="text" id="mold-search" placeholder="Search molds...">
            </div>
            <div class="filter-group">
              <label for="mold-vendor-filter">Vendor:</label>
              <select id="mold-vendor-filter">
                <option value="all">All Vendors</option>
              </select>
            </div>
            <div class="filter-group">
              <label>
                <input type="checkbox" id="show-archived"> Show Archived
              </label>
            </div>
          </div>
          
          <table id="molds-table">
            <thead>
              <tr>
                <th>Mold</th>
                <th>Vendor</th>
                <th>Par Level</th>
                <th>Current Stock</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="molds-body">
              <!-- Data will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Vendor Settings Tab -->
      <div id="vendors-tab" class="tab-content hidden">
        <h2>Vendor Settings</h2>
        <p>Manage vendors and their expected lead times</p>
        
        <div class="card">
          <h3>Add New Vendor</h3>
          <div class="form-row">
            <div>
              <label for="vendor-name">Vendor Name:</label>
              <input type="text" id="vendor-name" placeholder="e.g. Innova, Discraft">
            </div>
            <div>
              <label for="lead-time">Lead Time (days):</label>
              <input type="number" id="lead-time" placeholder="7" min="1" style="width: 60px;">
            </div>
            <button id="add-vendor-btn" class="btn">Add Vendor</button>
          </div>
        </div>
        
        <h3>Current Vendors</h3>
        <table id="vendors-table">
          <thead>
            <tr>
              <th>Vendor</th>
              <th>Lead Time (days)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="vendors-body">
            <!-- Data will be populated here -->
          </tbody>
        </table>
      </div>
      
      <!-- Settings Tab -->
      <div id="settings-tab" class="tab-content hidden">
        <h2>Settings</h2>
        
        <div class="card">
          <h3>Reorder Thresholds</h3>
          <p>Configure when to suggest ordering new inventory</p>
          
          <div class="form-row">
            <label for="min-stock">Minimum Stock Level:</label>
            <input type="number" id="min-stock" min="0" value="3" style="width: 60px;">
            <span>discs</span>
          </div>
          
          <div class="form-row">
            <label for="buffer-days">Buffer Days Beyond Lead Time:</label>
            <input type="number" id="buffer-days" min="0" value="7" style="width: 60px;">
            <span>days</span>
          </div>
          
          <div class="form-row">
            <label for="default-par">Default Par Level for New Molds:</label>
            <input type="number" id="default-par" min="0" value="15" style="width: 60px;">
            <span>discs</span>
          </div>
          
          <button id="save-settings-btn" class="btn">Save Settings</button>
        </div>
        
        <div class="card">
          <h3>Data Management</h3>
          
          <div class="form-row">
            <button id="export-data-btn" class="btn">Export All Data</button>
            <button id="import-data-btn" class="btn">Import Data</button>
            <input type="file" id="import-file" accept=".json" style="display: none;">
          </div>
        </div>
        
        <div class="card">
          <h3>Demo Information</h3>
          <p>This is running in demo mode with sample data. In a full implementation, this would connect to your Square API.</p>
          
          <div class="form-row">
            <button id="reset-demo-btn" class="btn btn-red">Reset Demo Data</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Application state
    const state = {
      locationId: localStorage.getItem('demo_location_id'),
      locationName: localStorage.getItem('demo_location_name'),
      locations: [],
      catalog: [],
      inventory: [],
      vendors: JSON.parse(localStorage.getItem('vendors')) || [
        { name: 'Innova', leadTime: 7 },
        { name: 'Discraft', leadTime: 7 },
        { name: 'MVP', leadTime: 14 },
        { name: 'Dynamic Discs', leadTime: 10 },
        { name: 'Latitude 64', leadTime: 10 },
        { name: 'Westside', leadTime: 10 }
      ],
      molds: JSON.parse(localStorage.getItem('molds')) || [],
      settings: JSON.parse(localStorage.getItem('settings')) || {
        minStock: 3,
        bufferDays: 7,
        defaultPar: 15
      },
      plasticTypes: [
        'Star', 'Champion', 'DX', 'Pro', 'GStar', 'Halo', 'Blizzard',
        'ESP', 'Z', 'FLX', 'Titanium', 'Jawbreaker', 'CryZtal',
        'Neutron', 'Plasma', 'Proton', 'Electron', 'Cosmic',
        'Gold', 'Opto', 'VIP', 'Tournament', 'Fuzion', 'Lucid'
      ],
      bestSellers: []
    };
    
    // DOM references
    const locationSelector = document.getElementById('location-selector');
    const appContent = document.getElementById('app-content');
    
// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
  // Remove demo mode indicator
  document.querySelector('.demo-badge').textContent = 'Live Mode';
  document.querySelector('.demo-badge').style.backgroundColor = '#4CAF50';
  
  // Update demo mode message
  document.querySelector('.message.info').innerHTML = `
    <p><strong>Live Mode Active</strong> - This version is connected to your Square account.
    All inventory changes will affect your actual inventory data.</p>
  `;
  
  // Update settings card
  const demoInfoCard = document.querySelector('#settings-tab .card:last-child');
  if (demoInfoCard) {
    demoInfoCard.innerHTML = `
      <h3>Square Integration Information</h3>
      <p>This system is connected to your Square account. Any changes to inventory will be reflected in your Square Dashboard.</p>
      <p>Location ID: LXXKTFPCR2TWF</p>
    `;
  }
  
  if (state.locationId) {
    // We have a location, show the app content
    showAppContent();
    
    // Load data from Square
    loadInventoryData();
    loadMoldsFromSquare();
    loadVendorsFromSquare();
  } else {
    // Select the default location
    state.locationId = "LXXKTFPCR2TWF";
    state.locationName = "Your Store";
    
    // Save default location
    localStorage.setItem('demo_location_id', state.locationId);
    localStorage.setItem('demo_location_name', state.locationName);
    
    // Show the app content
    showAppContent();
    
    // Load data from Square
    loadInventoryData();
    loadMoldsFromSquare();
    loadVendorsFromSquare();
  }
  
  // Load settings
  loadSettings();
  
  // Set up event listeners
  setupEventListeners();
});
    
    // Show location selector
    function showLocationSelector() {
      locationSelector.classList.remove('hidden');
      appContent.classList.add('hidden');
      loadLocations();
    }
    
    // Show main app content
    function showAppContent() {
      locationSelector.classList.add('hidden');
      appContent.classList.remove('hidden');
    }
    
    // Set up event listeners
    function setupEventListeners() {
      // Select location button
      const selectLocationBtn = document.getElementById('select-location-btn');
      if (selectLocationBtn) {
        selectLocationBtn.addEventListener('click', selectLocation);
      }
      
      // Tab navigation
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          // Remove active class from all tabs
          document.querySelectorAll('.tab').forEach(t => {
            t.classList.remove('active');
          });
          
          // Hide all tab contents
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
          });
          
          // Show the selected tab and content
          this.classList.add('active');
          const tabId = this.getAttribute('data-tab') + '-tab';
          document.getElementById(tabId).classList.remove('hidden');
        });
      });
      
      // Refresh data button
      const refreshBtn = document.getElementById('refresh-data');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', loadInventoryData);
      }
      
      // Generate report button
      const generateReportBtn = document.getElementById('generate-report');
      if (generateReportBtn) {
        generateReportBtn.addEventListener('click', generateBestSellersReport);
      }
      
      // Add vendor button
      const addVendorBtn = document.getElementById('add-vendor-btn');
      if (addVendorBtn) {
        addVendorBtn.addEventListener('click', addVendor);
      }
      
      // Add mold button
      const addMoldBtn = document.getElementById('add-mold-btn');
      if (addMoldBtn) {
        addMoldBtn.addEventListener('click', addMold);
      }
      
      // Save settings button
      const saveSettingsBtn = document.getElementById('save-settings-btn');
      if (saveSettingsBtn) {
        saveSettingsBtn.addEventListener('click', saveSettings);
      }
      
      // Export data button
      const exportDataBtn = document.getElementById('export-data-btn');
      if (exportDataBtn) {
        exportDataBtn.addEventListener('click', exportData);
      }
      
      // Import data button
      const importDataBtn = document.getElementById('import-data-btn');
      if (importDataBtn) {
        importDataBtn.addEventListener('click', function() {
          document.getElementById('import-file').click();
        });
      }
      
      // Import file change
      const importFile = document.getElementById('import-file');
      if (importFile) {
        importFile.addEventListener('change', importData);
      }
      
      // Reset demo data button
      const resetDemoBtn = document.getElementById('reset-demo-btn');
      if (resetDemoBtn) {
        resetDemoBtn.addEventListener('click', resetDemoData);
      }
      
      // Filter listeners
      setupFilterListeners();
    }
    
    // Set up filter listeners
    function setupFilterListeners() {
      // Reorder tab filters
      const statusFilter = document.getElementById('status-filter');
      const vendorFilter = document.getElementById('vendor-filter');
      const plasticFilter = document.getElementById('plastic-filter');
      const moldFilter = document.getElementById('mold-filter');
      
      if (statusFilter && vendorFilter && plasticFilter && moldFilter) {
        [statusFilter, vendorFilter, plasticFilter, moldFilter].forEach(filter => {
          filter.addEventListener('change', filterReorderTable);
        });
      }
      
      // Inventory tab filters
      const inventorySearch = document.getElementById('inventory-search');
      const inventoryVendor = document.getElementById('inventory-vendor');
      const inventoryPlastic = document.getElementById('inventory-plastic');
      const inventoryMold = document.getElementById('inventory-mold');
      
      if (inventorySearch && inventoryVendor && inventoryPlastic && inventoryMold) {
        inventorySearch.addEventListener('input', filterInventoryTable);
        [inventoryVendor, inventoryPlastic, inventoryMold].forEach(filter => {
          filter.addEventListener('change', filterInventoryTable);
        });
      }
      
      // Mold tab filters
      const moldSearch = document.getElementById('mold-search');
      const moldVendorFilter = document.getElementById('mold-vendor-filter');
      const showArchived = document.getElementById('show-archived');
      
      if (moldSearch && moldVendorFilter && showArchived) {
        moldSearch.addEventListener('input', filterMoldsTable);
        moldVendorFilter.addEventListener('change', filterMoldsTable);
        showArchived.addEventListener('change', filterMoldsTable);
      }
      
      // Best Sellers filters
      const timePeriod = document.getElementById('time-period');
      const bestsellerVendor = document.getElementById('bestseller-vendor');
      
      if (timePeriod && bestsellerVendor) {
        [timePeriod, bestsellerVendor].forEach(filter => {
          filter.addEventListener('change', filterBestSellers);
        });
      }
    }
    
    // Load locations from Square API
function loadLocations() {
  try {
    const locationSelect = document.getElementById('location-select');
    locationSelect.innerHTML = '<option value="">Loading locations...</option>';
    
    // Fetch locations from Square
    fetch('/.netlify/functions/locations')
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          state.locations = data.locations;
          
          // Populate location select
          locationSelect.innerHTML = '<option value="">Select a location...</option>';
          
          state.locations.forEach(location => {
            const option = document.createElement('option');
            option.value = location.id;
            option.textContent = location.name;
            locationSelect.appendChild(option);
          });
          
          // Select default if we have locationId
          if (state.locationId) {
            locationSelect.value = state.locationId;
          }
        } else {
          throw new Error(data.error || 'Failed to load locations');
        }
      })
      .catch(error => {
        console.error('Error loading locations:', error);
        
        locationSelect.innerHTML = '<option value="">Error loading locations</option>';
        
        // Default to using the provided location ID
        const option = document.createElement('option');
        option.value = "LXXKTFPCR2TWF";
        option.textContent = "Default Store Location";
        locationSelect.appendChild(option);
      });
  } catch (error) {
    console.error('Error initiating locations fetch:', error);
    
    const locationSelect = document.getElementById('location-select');
    locationSelect.innerHTML = '<option value="">Error loading locations</option>';
    
    // Default to using the provided location ID
    const option = document.createElement('option');
    option.value = "LXXKTFPCR2TWF";
    option.textContent = "Default Store Location";
    locationSelect.appendChild(option);
  }
}
    
    // Select location
    function selectLocation() {
      const locationSelect = document.getElementById('location-select');
      const locationId = locationSelect.value;
      
      if (!locationId) {
        alert('Please select a location');
        return;
      }
      
      // Find location name
      const location = state.locations.find(loc => loc.id === locationId);
      const locationName = location ? location.name : locationId;
      
      // Save location
      localStorage.setItem('demo_location_id', locationId);
      localStorage.setItem('demo_location_name', locationName);
      
      // Update state
      state.locationId = locationId;
      state.locationName = locationName;
      
      // Show app content
      showAppContent();
      
      // Load inventory data
      loadInventoryData();
    }
    
    // Load inventory data from Square API
function loadInventoryData() {
  try {
    // Show loading indicators
    document.getElementById('loading-data').classList.remove('hidden');
    document.getElementById('loading-inventory').classList.remove('hidden');
    
    // Fetch real inventory data from Square
    fetch('/.netlify/functions/getInventory')
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          // Store the inventory data
          state.inventory = data.inventory;
          
          // Generate bestsellers based on actual data or estimates
          generateBestSellers();
          
          // Process data for display
          processInventoryData();
          
          // Hide loading indicators
          document.getElementById('loading-data').classList.add('hidden');
          document.getElementById('loading-inventory').classList.add('hidden');
        } else {
          throw new Error(data.error || 'Failed to load inventory data');
        }
      })
      .catch(error => {
        console.error('Error loading inventory data:', error);
        
        // Hide loading indicators
        document.getElementById('loading-data').classList.add('hidden');
        document.getElementById('loading-inventory').classList.add('hidden');
        
        // Show error message
        const reorderContent = document.getElementById('reorder-content');
        reorderContent.innerHTML = `
          <div class="message error">
            <p>Error loading inventory data: ${error.message}</p>
          </div>
        `;
      });
  } catch (error) {
    console.error('Error initiating data fetch:', error);
    
    // Hide loading indicators
    document.getElementById('loading-data').classList.add('hidden');
    document.getElementById('loading-inventory').classList.add('hidden');
    
    // Show error message
    const reorderContent = document.getElementById('reorder-content');
    reorderContent.innerHTML = `
      <div class="message error">
        <p>Error loading inventory data: ${error.message}</p>
      </div>
    `;
  }
}
    
    // Generate demo data
    function generateDemoData() {
      // Sample disc data
      const discs = [
        { name: 'Star Destroyer', sku: 'INN-STR-DES-001', stock: 5, price: 17.99, vendor: 'Innova', plastic: 'Star', mold: 'Destroyer', sales30: 8, sales90: 25 },
        { name: 'Champion Destroyer', sku: 'INN-CHA-DES-002', stock: 3, price: 17.99, vendor: 'Innova', plastic: 'Champion', mold: 'Destroyer', sales30: 6, sales90: 18 },
        { name: 'ESP Zone', sku: 'DIS-ESP-ZON-001', stock: 2, price: 17.99, vendor: 'Discraft', plastic: 'ESP', mold: 'Zone', sales30: 12, sales90: 36 },
        { name: 'Z Zone', sku: 'DIS-Z-ZON-002', stock: 3, price: 17.99, vendor: 'Discraft', plastic: 'Z', mold: 'Zone', sales30: 9, sales90: 27 },
        { name: 'Neutron Envy', sku: 'MVP-NEU-ENV-001', stock: 15, price: 16.99, vendor: 'MVP', plastic: 'Neutron', mold: 'Envy', sales30: 4, sales90: 12 },
        { name: 'ESP Buzzz', sku: 'DIS-ESP-BUZ-001', stock: 6, price: 17.99, vendor: 'Discraft', plastic: 'ESP', mold: 'Buzzz', sales30: 14, sales90: 42 },
        { name: 'Z Buzzz', sku: 'DIS-Z-BUZ-002', stock: 8, price: 17.99, vendor: 'Discraft', plastic: 'Z', mold: 'Buzzz', sales30: 10, sales90: 30 },
        { name: 'Star Wraith', sku: 'INN-STR-WRA-001', stock: 4, price: 17.99, vendor: 'Innova', plastic: 'Star', mold: 'Wraith', sales30: 7, sales90: 21 },
        { name: 'Star Mako3', sku: 'INN-STR-MAK-001', stock: 10, price: 17.99, vendor: 'Innova', plastic: 'Star', mold: 'Mako3', sales30: 5, sales90: 15 },
        { name: 'Champion Mako3', sku: 'INN-CHA-MAK-002', stock: 12, price: 17.99, vendor: 'Innova', plastic: 'Champion', mold: 'Mako3', sales30: 3, sales90: 9 },
        { name: 'ESP Undertaker', sku: 'DIS-ESP-UND-001', stock: 8, price: 17.99, vendor: 'Discraft', plastic: 'ESP', mold: 'Undertaker', sales30: 6, sales90: 18 },
        { name: 'Z Undertaker', sku: 'DIS-Z-UND-002', stock: 9, price: 17.99, vendor: 'Discraft', plastic: 'Z', mold: 'Undertaker', sales30: 4, sales90: 12 },
        { name: 'Star Aviar', sku: 'INN-STR-AVI-001', stock: 14, price: 17.99, vendor: 'Innova', plastic: 'Star', mold: 'Aviar', sales30: 3, sales90: 9 },
        { name: 'DX Aviar', sku: 'INN-DX-AVI-002', stock: 20, price: 9.99, vendor: 'Innova', plastic: 'DX', mold: 'Aviar', sales30: 15, sales90: 45 },
        { name: 'Neutron Volt', sku: 'MVP-NEU-VOL-001', stock: 7, price: 16.99, vendor: 'MVP', plastic: 'Neutron', mold: 'Volt', sales30: 3, sales90: 9 },
        { name: 'Plasma Volt', sku: 'MVP-PLA-VOL-002', stock: 5, price: 18.99, vendor: 'MVP', plastic: 'Plasma', mold: 'Volt', sales30: 2, sales90: 6 },
        { name: 'Lucid Justice', sku: 'DD-LUC-JUS-001', stock: 9, price: 17.99, vendor: 'Dynamic Discs', plastic: 'Lucid', mold: 'Justice', sales30: 4, sales90: 12 },
        { name: 'Fuzion Justice', sku: 'DD-FUZ-JUS-002', stock: 11, price: 17.99, vendor: 'Dynamic Discs', plastic: 'Fuzion', mold: 'Justice', sales30: 3, sales90: 9 },
        { name: 'Gold Saint', sku: 'LAT-GOL-SAI-001', stock: 10, price: 17.99, vendor: 'Latitude 64', plastic: 'Gold', mold: 'Saint', sales30: 5, sales90: 15 },
        { name: 'Opto Saint', sku: 'LAT-OPT-SAI-002', stock: 8, price: 17.99, vendor: 'Latitude 64', plastic: 'Opto', mold: 'Saint', sales30: 4, sales90: 12 }
      ];
      
      // Store demo data
      state.inventory = discs;
      
      // Generate bestsellers based on sales data
      generateBestSellers();
    }
    
    // Generate best sellers data
    function generateBestSellers() {
      // Group by mold and calculate totals
      const moldSales = {};
      
      state.inventory.forEach(disc => {
        if (!moldSales[disc.mold]) {
          moldSales[disc.mold] = {
            mold: disc.mold,
            vendor: disc.vendor,
            unitsSold: 0,
            revenue: 0,
            stock: 0,
            parLevel: 0
          };
        }
        
        moldSales[disc.mold].unitsSold += disc.sales30;
        moldSales[disc.mold].revenue += disc.sales30 * disc.price;
        moldSales[disc.mold].stock += disc.stock;
        
        // Get par level from molds settings if available
        if (moldSales[disc.mold].parLevel === 0) {
          const moldSettings = state.molds.find(m => m.name === disc.mold);
          moldSales[disc.mold].parLevel = moldSettings ? moldSettings.parLevel : state.settings.defaultPar;
        }
      });
      
      // Convert to array and sort by units sold
      const sortedSales = Object.values(moldSales).sort((a, b) => b.unitsSold - a.unitsSold);
      
      // Calculate total sales for percentages
      const totalSales = sortedSales.reduce((sum, item) => sum + item.unitsSold, 0);
      
      // Add percentage and rank
      sortedSales.forEach((item, index) => {
        item.percentage = totalSales > 0 ? (item.unitsSold / totalSales) * 100 : 0;
        item.rank = index + 1;
      });
      
      // Store best sellers
      state.bestSellers = sortedSales;
    }
    
    // Generate best sellers report
    function generateBestSellersReport() {
      const timePeriod = document.getElementById('time-period').value;
      const vendorFilter = document.getElementById('bestseller-vendor').value;
      
      // Show loading indicator
      const bestsellersBody = document.getElementById('bestsellers-body');
      bestsellersBody.innerHTML = `
        <tr>
          <td colspan="8" style="text-align: center;">
            <i class="fas fa-spinner spinner"></i> Generating report...
          </td>
        </tr>
      `;
      
      // Simulate API delay
      setTimeout(() => {
        // Filter by vendor if needed
        let filteredSales = state.bestSellers;
        if (vendorFilter !== 'all') {
          filteredSales = filteredSales.filter(item => item.vendor === vendorFilter);
        }
        
        // Adjust sales data based on time period
        const timeFactor = {
          'day': 0.033,   // 1/30 of monthly sales
          'week': 0.25,   // 1/4 of monthly sales
          'month': 1,     // Monthly sales as is
          'year': 12,     // 12x monthly sales
          'all': 24       // 2 years worth of sales
        };
        
        const adjustedSales = filteredSales.map(item => {
          return {
            ...item,
            unitsSold: Math.round(item.unitsSold * timeFactor[timePeriod]),
            revenue: item.revenue * timeFactor[timePeriod]
          };
        });
        
        // Sort by adjusted units
        adjustedSales.sort((a, b) => b.unitsSold - a.unitsSold);
        
        // Recalculate ranks and percentages
        const totalAdjustedSales = adjustedSales.reduce((sum, item) => sum + item.unitsSold, 0);
        adjustedSales.forEach((item, index) => {
          item.percentage = totalAdjustedSales > 0 ? (item.unitsSold / totalAdjustedSales) * 100 : 0;
          item.rank = index + 1;
        });
        
        // Update bestsellers table
        updateBestsellersTable(adjustedSales);
        
        // Update trends table
        updateTrendsTable(adjustedSales);
      }, 600);
    }
    
    // Update bestsellers table
    function updateBestsellersTable(sales) {
      const tbody = document.getElementById('bestsellers-body');
      tbody.innerHTML = '';
      
      if (sales.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center;">No sales data available.</td>
          </tr>
        `;
        return;
      }
      
      sales.forEach(item => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${item.rank}</td>
          <td>${item.mold}</td>
          <td>${item.vendor}</td>
          <td>${item.unitsSold}</td>
          <td>$${item.revenue.toFixed(2)}</td>
          <td>${item.percentage.toFixed(1)}%</td>
          <td>${item.stock}</td>
          <td>${item.parLevel}</td>
        `;
        
        tbody.appendChild(row);
      });
    }
    
    // Update trends table
    function updateTrendsTable(sales) {
      const tbody = document.getElementById('trends-body');
      tbody.innerHTML = '';
      
      if (sales.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center;">No trend data available.</td>
          </tr>
        `;
        return;
      }
      
      // Show only top 5 sales
      const topSales = sales.slice(0, 5);
      
      // Generate random previous period data for demo
      topSales.forEach(item => {
        const row = document.createElement('tr');
        
        // Generate random previous sales (±30%)
        const variation = (Math.random() * 0.6) - 0.3; // -30% to +30%
        const previousSales = Math.round(item.unitsSold * (1 + variation));
        const change = previousSales > 0 ? ((item.unitsSold - previousSales) / previousSales) * 100 : 0;
        
        // Determine trend
        let trendIcon = '➡️ Stable';
        let changeColor = '#666';
        
        if (change > 5) {
          trendIcon = '↗️ Rising';
          changeColor = '#4CAF50';
        } else if (change < -5) {
          trendIcon = '↘️ Falling';
          changeColor = '#f44336';
        }
        
        row.innerHTML = `
          <td>${item.mold}</td>
          <td>${item.unitsSold}</td>
          <td>${previousSales}</td>
          <td style="color: ${changeColor}">${change > 0 ? '+' : ''}${change.toFixed(1)}%</td>
          <td>${trendIcon}</td>
        `;
        
        tbody.appendChild(row);
      });
    }
    
    // Filter best sellers
    function filterBestSellers() {
      generateBestSellersReport();
    }
    
    // Process inventory data
    function processInventoryData() {
      // Update molds from inventory data
      updateMoldsFromInventory();
      
      // Update inventory tables
      updateInventoryTables();
      
      // Update molds table
      updateMoldsTable();
      
      // Update vendor table
      updateVendorsTable();
      
      // Update filter dropdowns
      updateFilterDropdowns();
    }
    
    // Update molds from inventory data
    function updateMoldsFromInventory() {
      // Extract unique molds from inventory
      const inventoryMolds = [...new Set(state.inventory.map(item => item.mold))];
      
      // For each inventory mold, make sure it exists in state.molds
      inventoryMolds.forEach(moldName => {
        const existingMold = state.molds.find(m => m.name === moldName);
        
        if (!existingMold) {
          // Get a sample item with this mold to get the vendor
          const sampleItem = state.inventory.find(item => item.mold === moldName);
          
          // Add to molds list
          state.molds.push({
            name: moldName,
            vendor: sampleItem ? sampleItem.vendor : state.vendors[0].name,
            parLevel: state.settings.defaultPar,
            archived: false
          });
        }
      });
      
      // Save updated molds
      saveMolds();
    }
    
    // Update inventory tables
    function updateInventoryTables() {
      // Get mold settings
      const moldSettings = {};
      state.molds.forEach(mold => {
        moldSettings[mold.name] = {
          parLevel: mold.parLevel,
          archived: mold.archived
        };
      });
      
      // Process inventory items
      const processedItems = state.inventory.map(item => {
        // Get mold settings
        const mold = moldSettings[item.mold] || { parLevel: state.settings.defaultPar, archived: false };
        
        // Get vendor lead time
        const vendorObj = state.vendors.find(v => v.name === item.vendor);
        const leadTime = vendorObj ? vendorObj.leadTime : 7;
        
        // Calculate stock status
        let status = 'OK';
        let statusCode = 2;
        
        if (item.stock <= mold.parLevel * 0.2) {
          status = 'URGENT';
          statusCode = 0;
        } else if (item.stock <= mold.parLevel * 0.5) {
          status = 'SOON';
          statusCode = 1;
        }
        
        // Calculate recommended order
        const recommendedOrder = calculateRecommendedOrder(item.stock, mold.parLevel, leadTime);
        
        return {
          ...item,
          parLevel: mold.parLevel,
          archived: mold.archived,
          leadTime,
          status,
          statusCode,
          recommendedOrder
        };
      });
      
      // Filter out archived molds
      const activeItems = processedItems.filter(item => !item.archived);
      
      // Sort by status (URGENT first, then SOON, then OK) and then by mold
      activeItems.sort((a, b) => {
        if (a.statusCode !== b.statusCode) {
          return a.statusCode - b.statusCode;
        }
        if (a.mold !== b.mold) {
          return a.mold.localeCompare(b.mold);
        }
        return a.name.localeCompare(b.name);
      });
      
      // Update reorder table
      const reorderBody = document.getElementById('reorder-body');
      reorderBody.innerHTML = '';
      
      // Filter items that need reordering
      const reorderItems = activeItems.filter(item => item.recommendedOrder > 0);
      
      if (reorderItems.length === 0) {
        reorderBody.innerHTML = `
          <tr>
            <td colspan="10" style="text-align: center;">No items need reordering at this time.</td>
          </tr>
        `;
      } else {
        reorderItems.forEach(item => {
          const row = document.createElement('tr');
          
          row.innerHTML = `
            <td>${item.name}</td>
            <td><span class="plastic-badge">${item.plastic}</span></td>
            <td>${item.mold}</td>
            <td>${item.stock}</td>
            <td>${item.parLevel}</td>
            <td>${item.vendor}</td>
            <td>${item.leadTime} days</td>
            <td><span class="status-${item.status.toLowerCase()}">${item.status}</span></td>
            <td>${item.recommendedOrder}</td>
            <td><button class="btn order-btn" data-sku="${item.sku}">Order</button></td>
          `;
          
          reorderBody.appendChild(row);
        });
        
        // Add event listeners for order buttons
        document.querySelectorAll('.order-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const sku = this.getAttribute('data-sku');
            orderDisc(sku);
          });
        });
      }
      
      // Update inventory table
      const inventoryBody = document.getElementById('inventory-body');
      inventoryBody.innerHTML = '';
      
      if (activeItems.length === 0) {
        inventoryBody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center;">No inventory items found.</td>
          </tr>
        `;
      } else {
        activeItems.forEach(item => {
          const row = document.createElement('tr');
          
          row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.sku || ''}</td>
            <td><span class="plastic-badge">${item.plastic}</span></td>
            <td>${item.mold}</td>
            <td>${item.vendor}</td>
            <td>${item.stock}</td>
            <td>${item.parLevel}</td>
            <td>$${item.price.toFixed(2)}</td>
          `;
          
          inventoryBody.appendChild(row);
        });
      }
    }
    
    // Update molds table
    function updateMoldsTable() {
      // Calculate total stock for each mold
      const moldStock = {};
      
      state.inventory.forEach(item => {
        if (!moldStock[item.mold]) {
          moldStock[item.mold] = 0;
        }
        
        moldStock[item.mold] += item.stock;
      });
      
      // Sort molds
      state.molds.sort((a, b) => {
        if (a.archived !== b.archived) {
          return a.archived ? 1 : -1;
        }
        return a.name.localeCompare(b.name);
      });
      
      // Update molds table
      const moldsBody = document.getElementById('molds-body');
      moldsBody.innerHTML = '';
      
      if (state.molds.length === 0) {
        moldsBody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center;">No molds found.</td>
          </tr>
        `;
      } else {
        state.molds.forEach(mold => {
          const row = document.createElement('tr');
          
          if (mold.archived) {
            row.style.backgroundColor = '#f9f9f9';
            row.style.color = '#999';
          }
          
          const status = mold.archived ? 
            '<span style="display: inline-block; padding: 3px 8px; background-color: #999; color: white; border-radius: 4px; font-size: 12px;">Archived</span>' :
            '<span style="display: inline-block; padding: 3px 8px; background-color: #4CAF50; color: white; border-radius: 4px; font-size: 12px;">Active</span>';
          
          row.innerHTML = `
            <td>${mold.name}</td>
            <td>${mold.vendor}</td>
            <td>
              <input type="number" value="${mold.parLevel}" min="0" style="width: 60px;" 
                ${mold.archived ? 'disabled' : ''} data-mold="${mold.name}">
            </td>
            <td>${moldStock[mold.name] || 0}</td>
            <td>${status}</td>
            <td>
              ${mold.archived ?
                `<button class="btn btn-green unarchive-btn" data-mold="${mold.name}">Unarchive</button>` :
                `<button class="btn save-par-btn" data-mold="${mold.name}">Save</button>
                 <button class="btn btn-red archive-btn" data-mold="${mold.name}">Archive</button>`
              }
            </td>
          `;
          
          moldsBody.appendChild(row);
        });
        
        // Add event listeners for mold actions
        document.querySelectorAll('.save-par-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const moldName = this.getAttribute('data-mold');
            const input = document.querySelector(`input[data-mold="${moldName}"]`);
            const parLevel = parseInt(input.value);
            
            saveMoldParLevel(moldName, parLevel);
          });
        });
        
        document.querySelectorAll('.archive-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const moldName = this.getAttribute('data-mold');
            
            if (confirm(`Are you sure you want to archive ${moldName}? This will set its par level to 0.`)) {
              archiveMold(moldName);
            }
          });
        });
        
        document.querySelectorAll('.unarchive-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const moldName = this.getAttribute('data-mold');
            unarchiveMold(moldName);
          });
        });
      }
    }
    
    // Update vendors table
    function updateVendorsTable() {
      const vendorsBody = document.getElementById('vendors-body');
      vendorsBody.innerHTML = '';
      
      if (state.vendors.length === 0) {
        vendorsBody.innerHTML = `
          <tr>
            <td colspan="3" style="text-align: center;">No vendors found.</td>
          </tr>
        `;
      } else {
        state.vendors.forEach((vendor, index) => {
          const row = document.createElement('tr');
          
          row.innerHTML = `
            <td>${vendor.name}</td>
            <td>${vendor.leadTime} days</td>
            <td>
              <button class="btn edit-vendor-btn" data-index="${index}">Edit</button>
              <button class="btn btn-red delete-vendor-btn" data-index="${index}">Delete</button>
            </td>
          `;
          
          vendorsBody.appendChild(row);
        });
        
        // Add event listeners for vendor actions
        document.querySelectorAll('.edit-vendor-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            editVendor(index);
          });
        });
        
        document.querySelectorAll('.delete-vendor-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            deleteVendor(index);
          });
        });
      }
    }
    
    // Update filter dropdowns
    function updateFilterDropdowns() {
      // Extract unique values
      const vendors = [...new Set(state.inventory.map(item => item.vendor))];
      const plastics = [...new Set(state.inventory.map(item => item.plastic))];
      const molds = [...new Set(state.inventory.map(item => item.mold))];
      
      // Sort values
      vendors.sort();
      plastics.sort();
      molds.sort();
      
      // Update vendor dropdowns
      updateDropdown('vendor-filter', vendors);
      updateDropdown('inventory-vendor', vendors);
      updateDropdown('mold-vendor-filter', vendors);
      updateDropdown('new-mold-vendor', vendors);
      updateDropdown('bestseller-vendor', vendors);
      
      // Update plastic dropdowns
      updateDropdown('plastic-filter', plastics);
      updateDropdown('inventory-plastic', plastics);
      
      // Update mold dropdowns
      updateDropdown('mold-filter', molds);
      updateDropdown('inventory-mold', molds);
    }
    
    // Update a dropdown with options
    function updateDropdown(id, options) {
      const dropdown = document.getElementById(id);
      if (!dropdown) return;
      
      // Keep the first option (usually "All")
      const firstOption = dropdown.options[0];
      dropdown.innerHTML = '';
      dropdown.appendChild(firstOption);
      
      // Add options
      options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        dropdown.appendChild(optionElement);
      });
    }
    
    // Filter reorder table
    function filterReorderTable() {
      const statusFilter = document.getElementById('status-filter').value;
      const vendorFilter = document.getElementById('vendor-filter').value;
      const plasticFilter = document.getElementById('plastic-filter').value;
      const moldFilter = document.getElementById('mold-filter').value;
      
      const rows = document.querySelectorAll('#reorder-body tr');
      
      rows.forEach(row => {
        // Skip rows with colspan (no results message)
        if (row.querySelector('td[colspan]')) return;
        
        const status = row.querySelector('td:nth-child(8) span').textContent;
        const vendor = row.querySelector('td:nth-child(6)').textContent;
        const plastic = row.querySelector('td:nth-child(2) span').textContent;
        const mold = row.querySelector('td:nth-child(3)').textContent;
        
        const statusMatch = statusFilter === 'all' || status.toLowerCase() === statusFilter.toLowerCase();
        const vendorMatch = vendorFilter === 'all' || vendor === vendorFilter;
        const plasticMatch = plasticFilter === 'all' || plastic === plasticFilter;
        const moldMatch = moldFilter === 'all' || mold === moldFilter;
        
        row.style.display = statusMatch && vendorMatch && plasticMatch && moldMatch ? '' : 'none';
      });
    }
    
    // Filter inventory table
    function filterInventoryTable() {
      const searchValue = document.getElementById('inventory-search').value.toLowerCase();
      const vendorFilter = document.getElementById('inventory-vendor').value;
      const plasticFilter = document.getElementById('inventory-plastic').value;
      const moldFilter = document.getElementById('inventory-mold').value;
      
      const rows = document.querySelectorAll('#inventory-body tr');
      
      rows.forEach(row => {
        // Skip rows with colspan (no results message)
        if (row.querySelector('td[colspan]')) return;
        
        const name = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
        const sku = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        const plastic = row.querySelector('td:nth-child(3) span').textContent;
        const mold = row.querySelector('td:nth-child(4)').textContent;
        const vendor = row.querySelector('td:nth-child(5)').textContent;
        
        const searchMatch = 
          name.includes(searchValue) || 
          sku.includes(searchValue) || 
          mold.toLowerCase().includes(searchValue);
          
        const vendorMatch = vendorFilter === 'all' || vendor === vendorFilter;
        const plasticMatch = plasticFilter === 'all' || plastic === plasticFilter;
        const moldMatch = moldFilter === 'all' || mold === moldFilter;
        
        row.style.display = searchMatch && vendorMatch && plasticMatch && moldMatch ? '' : 'none';
      });
    }
    
    // Filter molds table
    function filterMoldsTable() {
      const searchValue = document.getElementById('mold-search').value.toLowerCase();
      const vendorFilter = document.getElementById('mold-vendor-filter').value;
      const showArchived = document.getElementById('show-archived').checked;
      
      const rows = document.querySelectorAll('#molds-body tr');
      
      rows.forEach(row => {
        // Skip rows with colspan (no results message)
        if (row.querySelector('td[colspan]')) return;
        
        const mold = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
        const vendor = row.querySelector('td:nth-child(2)').textContent;
        const status = row.querySelector('td:nth-child(5) span').textContent;
        const isArchived = status === 'Archived';
        
        const searchMatch = mold.includes(searchValue);
        const vendorMatch = vendorFilter === 'all' || vendor === vendorFilter;
        const archivedMatch = showArchived || !isArchived;
        
        row.style.display = searchMatch && vendorMatch && archivedMatch ? '' : 'none';
      });
    }
    
    // Calculate recommended order quantity
    function calculateRecommendedOrder(stock, parLevel, leadTime) {
      if (stock >= parLevel) {
        return 0;
      }
      
      // Basic calculation: par level - current stock
      let recommendedOrder = parLevel - stock;
      
      // Add buffer based on lead time
      const buffer = Math.ceil(state.settings.bufferDays / leadTime);
      recommendedOrder += buffer;
      
      return recommendedOrder;
    }
    
   // Add vendor
    function addVendor() {
      const nameInput = document.getElementById('vendor-name');
      const leadTimeInput = document.getElementById('lead-time');
      
      const name = nameInput.value.trim();
      const leadTime = parseInt(leadTimeInput.value);
      
      if (!name) {
        alert('Please enter a vendor name');
        return;
      }
      
      if (isNaN(leadTime) || leadTime < 1) {
        alert('Please enter a valid lead time (must be at least 1 day)');
        return;
      }
      
      // Check if vendor already exists
      const existingVendor = state.vendors.find(v => v.name.toLowerCase() === name.toLowerCase());
      if (existingVendor) {
        alert(`Vendor "${name}" already exists`);
        return;
      }
      
      // Add vendor
      state.vendors.push({
        name,
        leadTime
      });
      
      // Save vendors
      saveVendors();
      
      // Update vendor table
      updateVendorsTable();
      
      // Clear inputs
      nameInput.value = '';
      leadTimeInput.value = '';
      
      // Update dropdowns
      updateFilterDropdowns();
    }
    
    // Edit vendor
    function editVendor(index) {
      const vendor = state.vendors[index];
      
      const newName = prompt('Vendor name:', vendor.name);
      if (!newName) return;
      
      const newLeadTime = parseInt(prompt('Lead time (days):', vendor.leadTime));
      if (isNaN(newLeadTime) || newLeadTime < 1) {
        alert('Please enter a valid lead time (must be at least 1 day)');
        return;
      }
      
      // Update vendor
      vendor.name = newName;
      vendor.leadTime = newLeadTime;
      
      // Save vendors
      saveVendors();
      
      // Update vendor table
      updateVendorsTable();
      
      // Update inventory data
      processInventoryData();
    }
    
    // Delete vendor
    function deleteVendor(index) {
      const vendor = state.vendors[index];
      
      if (!confirm(`Are you sure you want to delete vendor "${vendor.name}"?`)) {
        return;
      }
      
      // Remove vendor
      state.vendors.splice(index, 1);
      
      // Save vendors
      saveVendors();
      
      // Update vendor table
      updateVendorsTable();
      
      // Update inventory data
      processInventoryData();
    }
    
    // Save vendors to localStorage
    function saveVendors() {
      localStorage.setItem('vendors', JSON.stringify(state.vendors));
    }
    
    // Add mold
    function addMold() {
      const nameInput = document.getElementById('new-mold-name');
      const vendorSelect = document.getElementById('new-mold-vendor');
      const parInput = document.getElementById('new-mold-par');
      
      const name = nameInput.value.trim();
      const vendor = vendorSelect.value;
      const parLevel = parseInt(parInput.value);
      
      if (!name) {
        alert('Please enter a mold name');
        return;
      }
      
      if (!vendor) {
        alert('Please select a vendor');
        return;
      }
      
      if (isNaN(parLevel) || parLevel < 0) {
        alert('Please enter a valid par level (must be 0 or higher)');
        return;
      }
      
      // Check if mold already exists
      const existingMold = state.molds.find(m => m.name.toLowerCase() === name.toLowerCase());
      if (existingMold) {
        alert(`Mold "${name}" already exists`);
        return;
      }
      
      // Add mold
      state.molds.push({
        name,
        vendor,
        parLevel,
        archived: false
      });
      
      // Save molds
      saveMolds();
      
      // Reload inventory data to update tables
      processInventoryData();
      
      // Clear inputs
      nameInput.value = '';
      parInput.value = state.settings.defaultPar;
    }
    
    // Save mold par level
    function saveMoldParLevel(moldName, parLevel) {
      if (isNaN(parLevel) || parLevel < 0) {
        alert('Please enter a valid par level (must be 0 or higher)');
        return;
      }
      
      // Find mold
      const mold = state.molds.find(m => m.name === moldName);
      
      if (mold) {
        // Update par level
        mold.parLevel = parLevel;
      } else {
        // Create new mold
        const vendorSelect = document.getElementById('mold-vendor-filter');
        const vendor = vendorSelect.value !== 'all' ? vendorSelect.value : state.vendors[0]?.name || 'Unknown';
        
        state.molds.push({
          name: moldName,
          vendor,
          parLevel,
          archived: false
        });
      }
      
      // Save molds
      saveMolds();
      
      // Show confirmation
      alert(`Par level for ${moldName} saved as ${parLevel}`);
      
      // Reload inventory data to update tables
      processInventoryData();
    }
    
    // Archive mold
    function archiveMold(moldName) {
      const mold = state.molds.find(m => m.name === moldName);
      
      if (mold) {
        mold.archived = true;
        mold.parLevel = 0;
      } else {
        const vendorSelect = document.getElementById('mold-vendor-filter');
        const vendor = vendorSelect.value !== 'all' ? vendorSelect.value : state.vendors[0]?.name || 'Unknown';
        
        state.molds.push({
          name: moldName,
          vendor,
          parLevel: 0,
          archived: true
        });
      }
      
      // Save molds
      saveMolds();
      
      // Reload inventory data to update tables
      processInventoryData();
    }
    
    // Unarchive mold
    function unarchiveMold(moldName) {
      const mold = state.molds.find(m => m.name === moldName);
      
      if (mold) {
        mold.archived = false;
        mold.parLevel = state.settings.defaultPar;
      }
      
      // Save molds
      saveMolds();
      
      // Reload inventory data to update tables
      processInventoryData();
    }
    
    // Save molds to localStorage
    function saveMolds() {
      localStorage.setItem('molds', JSON.stringify(state.molds));
    }
    // Order disc - use Square API
function orderDisc(sku) {
  const disc = state.inventory.find(item => item.sku === sku);
  
  if (!disc) {
    alert('Disc not found');
    return;
  }
  
  // Get vendor
  const vendor = state.vendors.find(v => v.name === disc.vendor);
  
  // Calculate recommended order
  const mold = state.molds.find(m => m.name === disc.mold);
  const parLevel = mold ? mold.parLevel : state.settings.defaultPar;
  const leadTime = vendor ? vendor.leadTime : 7;
  const recommendedOrder = calculateRecommendedOrder(disc.stock, parLevel, leadTime);
  
  // Ask for quantity
  const quantity = prompt(`Order ${disc.name} from ${disc.vendor}?`, recommendedOrder);
  
  if (quantity === null) return;
  
  const orderQuantity = parseInt(quantity);
  
  if (isNaN(orderQuantity) || orderQuantity <= 0) {
    alert('Please enter a valid quantity');
    return;
  }
  
  // Show loading indication
  const orderButton = document.querySelector(`.order-btn[data-sku="${sku}"]`);
  const originalText = orderButton.textContent;
  orderButton.textContent = 'Processing...';
  orderButton.disabled = true;

  // Use Square API to update inventory
  // This assumes you'd create a purchase order in your real system
  // For now, we'll just update the inventory count
  fetch('/.netlify/functions/updateInventory', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      catalogObjectId: disc.id,
      quantity: String(orderQuantity),
      fromState: 'NONE',
      toState: 'IN_STOCK'
    })
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! Status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      alert(`Order placed for ${orderQuantity} ${disc.name} from ${disc.vendor}`);
      
      // Update local inventory count
      disc.stock += orderQuantity;
      
      // Update tables
      processInventoryData();
    } else {
      throw new Error(data.error || 'Failed to update inventory');
    }
  })
  .catch(error => {
    console.error('Error placing order:', error);
    alert(`Error placing order: ${error.message}`);
  })
  .finally(() => {
    // Restore button state
    orderButton.textContent = originalText;
    orderButton.disabled = false;
  });
}
    
    // Save settings
    function saveSettings() {
      const minStock = parseInt(document.getElementById('min-stock').value);
      const bufferDays = parseInt(document.getElementById('buffer-days').value);
      const defaultPar = parseInt(document.getElementById('default-par').value);
      
      if (isNaN(minStock) || minStock < 0) {
        alert('Please enter a valid minimum stock level (must be 0 or higher)');
        return;
      }
      
      if (isNaN(bufferDays) || bufferDays < 0) {
        alert('Please enter a valid buffer days (must be 0 or higher)');
        return;
      }
      
      if (isNaN(defaultPar) || defaultPar < 0) {
        alert('Please enter a valid default par level (must be 0 or higher)');
        return;
      }
      
      // Update settings
      state.settings.minStock = minStock;
      state.settings.bufferDays = bufferDays;
      state.settings.defaultPar = defaultPar;
      
      // Save settings
      localStorage.setItem('settings', JSON.stringify(state.settings));
      
      // Show confirmation
      alert('Settings saved successfully');
      
      // Reload inventory data to update tables
      processInventoryData();
    }
    
    // Load settings
    function loadSettings() {
      // Update settings UI
      document.getElementById('min-stock').value = state.settings.minStock;
      document.getElementById('buffer-days').value = state.settings.bufferDays;
      document.getElementById('default-par').value = state.settings.defaultPar;
      
      // Update vendors table
      updateVendorsTable();
    }
    
    // Export data
    function exportData() {
      const data = {
        exportDate: new Date().toISOString(),
        settings: state.settings,
        vendors: state.vendors,
        molds: state.molds
      };
      
      // Create blob and download
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `disc-inventory-export-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
    }
    
    // Import data
    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          // Validate data
          if (!data.settings || !data.vendors || !data.molds) {
            throw new Error('Invalid import file format');
          }
          
          // Import data
          state.settings = data.settings;
          state.vendors = data.vendors;
          state.molds = data.molds;
          
          // Save to localStorage
          localStorage.setItem('settings', JSON.stringify(state.settings));
          localStorage.setItem('vendors', JSON.stringify(state.vendors));
          localStorage.setItem('molds', JSON.stringify(state.molds));
          
          // Update UI
          loadSettings();
          processInventoryData();
          
          // Show confirmation
          alert('Data imported successfully');
        } catch (error) {
          console.error('Import error:', error);
          alert(`Error importing data: ${error.message}`);
        }
      };
      
      reader.readAsText(file);
    }
    
    // Reset demo data
    function resetDemoData() {
      if (!confirm('Are you sure you want to reset all demo data? This will clear all your settings, vendors, and molds.')) {
        return;
      }
      
      // Clear localStorage
      localStorage.removeItem('vendors');
      localStorage.removeItem('molds');
      localStorage.removeItem('settings');
      
      // Reset state
      state.vendors = [
        { name: 'Innova', leadTime: 7 },
        { name: 'Discraft', leadTime: 7 },
        { name: 'MVP', leadTime: 14 },
        { name: 'Dynamic Discs', leadTime: 10 },
        { name: 'Latitude 64', leadTime: 10 },
        { name: 'Westside', leadTime: 10 }
      ];
      
      state.molds = [];
      
      state.settings = {
        minStock: 3,
        bufferDays: 7,
        defaultPar: 15
      };
      
      // Save default data
      saveVendors();
      saveMolds();
      localStorage.setItem('settings', JSON.stringify(state.settings));
      
      // Reload data
      loadSettings();
      loadInventoryData();
      
      // Show confirmation
      alert('Demo data has been reset successfully');
    }
    // Load molds from Square
function loadMoldsFromSquare() {
  try {
    fetch('/.netlify/functions/getMolds')
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          // Merge molds from Square with local settings
          mergeMoldsData(data.molds);
        } else {
          throw new Error(data.error || 'Failed to load molds');
        }
      })
      .catch(error => {
        console.error('Error loading molds:', error);
      });
  } catch (error) {
    console.error('Error initiating molds fetch:', error);
  }
}

// Merge molds from Square with local settings
function mergeMoldsData(squareMolds) {
  // Create a map of existing molds for quick lookup
  const existingMolds = {};
  state.molds.forEach(mold => {
    existingMolds[mold.name] = mold;
  });
  
  // Update molds array with Square data, preserving local settings
  const updatedMolds = squareMolds.map(squareMold => {
    const existingMold = existingMolds[squareMold.name];
    
    if (existingMold) {
      // Preserve local settings
      return {
        ...squareMold,
        parLevel: existingMold.parLevel,
        archived: existingMold.archived
      };
    } else {
      // Use defaults for new molds
      return squareMold;
    }
  });
  
  // Add any molds that are in local storage but not in Square
  // (this handles archived molds that might not be in catalog)
  state.molds.forEach(localMold => {
    const exists = updatedMolds.some(mold => mold.name === localMold.name);
    if (!exists) {
      updatedMolds.push(localMold);
    }
  });
  
  // Update state and save
  state.molds = updatedMolds;
  saveMolds();
  
  // Update UI
  updateMoldsTable();
}

// Load vendors from Square
function loadVendorsFromSquare() {
  try {
    fetch('/.netlify/functions/getVendors')
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          // Merge vendors from Square with local settings
          mergeVendorsData(data.vendors);
        } else {
          throw new Error(data.error || 'Failed to load vendors');
        }
      })
      .catch(error => {
        console.error('Error loading vendors:', error);
      });
  } catch (error) {
    console.error('Error initiating vendors fetch:', error);
  }
}

// Merge vendors from Square with local settings
function mergeVendorsData(squareVendors) {
  // Create a map of existing vendors for quick lookup
  const existingVendors = {};
  state.vendors.forEach(vendor => {
    existingVendors[vendor.name] = vendor;
  });
  
  // Update vendors array with Square data, preserving local settings
  const updatedVendors = squareVendors.map(squareVendor => {
    const existingVendor = existingVendors[squareVendor.name];
    
    if (existingVendor) {
      // Preserve local settings
      return {
        ...squareVendor,
        leadTime: existingVendor.leadTime
      };
    } else {
      // Use defaults for new vendors
      return squareVendor;
    }
  });
  
  // Add any vendors that are in local storage but not in Square
  state.vendors.forEach(localVendor => {
    const exists = updatedVendors.some(vendor => vendor.name === localVendor.name);
    if (!exists) {
      updatedVendors.push(localVendor);
    }
  });
  
  // Update state and save
  state.vendors = updatedVendors;
  saveVendors();
  
  // Update UI
  updateVendorsTable();
}
  </script>
</body>
</html>
